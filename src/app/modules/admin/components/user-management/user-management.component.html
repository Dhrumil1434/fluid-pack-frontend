<!-- Admin User Management — Shell with Sidebar -->
<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>
<app-admin-sidebar
  [collapsed]="sidebarCollapsed"
  (collapseChange)="sidebarCollapsed = $event"
></app-admin-sidebar>

<div
  class="transition-all duration-300"
  [class.ml-16]="sidebarCollapsed"
  [class.ml-64]="!sidebarCollapsed"
>
  <!-- Header -->
  <app-page-header
    title="User Management"
    subtitle="Manage users, roles, and permissions"
    [sidebarCollapsed]="sidebarCollapsed"
    (toggleSidebar)="sidebarCollapsed = !sidebarCollapsed"
    [breadcrumbs]="[
      { label: 'Dashboard', route: '/admin/dashboard' },
      { label: 'User Management' },
    ]"
  >
    <div headerActions class="flex items-center gap-2">
      <button
        class="p-2.5 text-gray-500 hover:text-gray-700 hover:bg-gray-50 rounded-lg transition-all duration-200"
        title="Refresh"
        (click)="ngOnInit()"
      >
        <i class="pi pi-refresh text-lg"></i>
      </button>
      <button
        (click)="onOpenAddUser()"
        class="px-4 py-2 bg-primary text-white rounded-md font-medium transition-colors duration-150 hover:bg-primary/90 cursor-pointer"
        title="Add new user"
      >
        <i class="pi pi-user-plus mr-2"></i>
        Add User
      </button>
    </div>
  </app-page-header>

  <main class="p-6 space-y-6">
    <!-- KPI Strip -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div
        class="bg-bg border border-neutral-300 rounded-xl shadow-medium p-4 flex items-center gap-3"
      >
        <div
          class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center"
        >
          <i class="pi pi-users" style="color: var(--color-primary)"></i>
        </div>
        <div>
          <div class="text-xs text-text-muted">Total Users</div>
          <div class="text-xl font-semibold text-text">
            {{ totalUsers ?? '—' }}
          </div>
        </div>
      </div>
      <div
        class="bg-bg border border-neutral-300 rounded-xl shadow-medium p-4 flex items-center gap-3"
      >
        <div
          class="w-10 h-10 rounded-full bg-success/10 flex items-center justify-center"
        >
          <i class="pi pi-check-circle" style="color: var(--color-success)"></i>
        </div>
        <div>
          <div class="text-xs text-text-muted">Approved</div>
          <div class="text-xl font-semibold text-text">
            {{ approvedUsers ?? '—' }}
          </div>
        </div>
      </div>
      <div
        class="bg-bg border border-neutral-300 rounded-xl shadow-medium p-4 flex items-center gap-3"
      >
        <div
          class="w-10 h-10 rounded-full bg-warning/10 flex items-center justify-center"
        >
          <i class="pi pi-clock" style="color: var(--color-warning)"></i>
        </div>
        <div>
          <div class="text-xs text-text-muted">Pending</div>
          <div class="text-xl font-semibold text-text">
            {{ pendingUsers ?? '—' }}
          </div>
        </div>
      </div>
    </section>

    <!-- Filters Card -->
    <section
      class="bg-bg border border-neutral-300 rounded-xl shadow-medium p-6"
    >
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold text-text">Filters</h2>
        <div class="text-xs text-text-muted" *ngIf="loadingFilters">
          Loading...
        </div>
      </div>
      <form
        [formGroup]="filtersForm"
        class="grid grid-cols-1 md:grid-cols-5 gap-4"
      >
        <div class="md:col-span-2">
          <label class="block text-xs text-text-muted mb-1">Search</label>
          <input
            type="text"
            class="w-full border border-neutral-300 rounded-md px-3 py-2 bg-bg text-text"
            placeholder="Search by name or email"
            formControlName="search"
          />
        </div>
        <div>
          <label class="block text-xs text-text-muted mb-1">Role</label>
          <select
            class="w-full border border-neutral-300 rounded-md px-3 py-2 bg-bg text-text"
            formControlName="role"
          >
            <option value="">All</option>
            <option *ngFor="let r of roles; trackBy: trackById" [value]="r._id">
              {{ r.name }}
            </option>
          </select>
        </div>
        <div>
          <label class="block text-xs text-text-muted mb-1">Department</label>
          <select
            class="w-full border border-neutral-300 rounded-md px-3 py-2 bg-bg text-text"
            formControlName="department"
          >
            <option value="">All</option>
            <option
              *ngFor="let d of departments; trackBy: trackById"
              [value]="d._id"
            >
              {{ d.name }}
            </option>
          </select>
        </div>
        <div>
          <label class="block text-xs text-text-muted mb-1">Status</label>
          <select
            class="w-full border border-neutral-300 rounded-md px-3 py-2 bg-bg text-text"
            formControlName="status"
          >
            <option value="">All</option>
            <option value="approved">Approved</option>
            <option value="pending">Pending</option>
          </select>
        </div>
        <div>
          <label class="block text-xs text-text-muted mb-1">From</label>
          <input
            type="date"
            class="w-full border border-neutral-300 rounded-md px-3 py-2 bg-bg text-text"
            formControlName="dateFrom"
          />
        </div>
        <div>
          <label class="block text-xs text-text-muted mb-1">To</label>
          <input
            type="date"
            class="w-full border border-neutral-300 rounded-md px-3 py-2 bg-bg text-text"
            formControlName="dateTo"
          />
        </div>
        <div class="md:col-span-5 flex items-center justify-end gap-2 pt-2">
          <button
            type="button"
            (click)="onClearFilters()"
            class="px-3 py-2 rounded-md border border-neutral-300 text-text hover:bg-neutral-50 cursor-pointer transition-colors"
          >
            Clear
          </button>
          <button
            type="button"
            (click)="onApplyFilters()"
            [disabled]="!canApply"
            class="px-3 py-2 rounded-md text-white cursor-pointer transition-colors disabled:cursor-not-allowed disabled:opacity-50"
            [class.bg-primary]="!applying"
            [class.bg-neutral-400]="applying"
          >
            <span *ngIf="!applying">Apply</span>
            <span *ngIf="applying" class="inline-flex items-center gap-2">
              <i class="pi pi-spin pi-spinner text-white"></i>
              Applying
            </span>
          </button>
        </div>
      </form>
    </section>

    <!-- Users Table -->
    <section>
      <app-user-table
        [filters]="appliedFilters"
        [initialPage]="qp.page"
        [initialLimit]="qp.limit"
        [initialSortBy]="qp.sortBy"
        [initialSortOrder]="qp.sortOrder"
        [processing]="rowProcessing"
        (view)="onViewUser($event)"
        (approve)="onApproveUser($event)"
        (reject)="onRejectUser($event)"
        (edit)="onEditUser($event)"
        (pageChange)="onTablePageChange($event)"
        (sortChange)="onTableSortChange($event)"
        (limitChange)="onTableLimitChange($event)"
      ></app-user-table>
    </section>
  </main>

  <!-- Approve/Reject Dialog -->
  <app-approve-reject-dialog
    [visible]="showApproveReject"
    [mode]="approveMode"
    [loading]="actionLoading"
    (cancel)="onCancelApproveReject()"
    (confirm)="onConfirmApproveReject()"
  ></app-approve-reject-dialog>

  <!-- Add User Modal -->
  <app-add-user-modal
    [visible]="showAddUser"
    [roles]="roles"
    [departments]="departments"
    [loading]="addUserLoading"
    (cancel)="onCancelAddUser()"
    (submitForm)="onCreateUser($event)"
  ></app-add-user-modal>

  <!-- Edit User Modal -->
  <app-edit-user-modal
    [visible]="showEditUser"
    [user]="selectedUser"
    [roles]="roles"
    [departments]="departments"
    [loading]="editUserLoading"
    (visibleChange)="onCancelEditUser()"
    (save)="onUpdateUser($event)"
  ></app-edit-user-modal>

  <!-- User Details Modal -->
  <app-user-details-modal
    [visible]="showUserDetails"
    [user]="selectedUser"
    [loading]="actionLoading"
    (visibleChange)="onCloseUserDetails()"
    (edit)="onEditFromDetails($event)"
    (approve)="onApproveFromDetails($event)"
    (reject)="onRejectFromDetails($event)"
  ></app-user-details-modal>
</div>

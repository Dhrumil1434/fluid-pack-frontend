<div class="border border-neutral-300 rounded-xl overflow-hidden">
  <div
    class="flex items-center justify-between px-4 py-3 bg-bg border-b border-neutral-300"
  >
    <div class="text-sm text-text-muted">{{ total }} users</div>
  </div>

  <div class="overflow-auto" [class.text-sm]="isCompact">
    <table class="w-full">
      <thead class="bg-neutral-50 text-left">
        <tr>
          <th
            class="px-4 py-3 cursor-pointer min-w-[240px] w-[200px]"
            (click)="onSort('username')"
          >
            User
          </th>
          <th
            class="px-4 py-3 cursor-pointer"
            *ngIf="visibleColumns['email']"
            (click)="onSort('email')"
          >
            Email
          </th>
          <th class="px-4 py-3" *ngIf="visibleColumns['role']">Role</th>
          <th class="px-4 py-3" *ngIf="visibleColumns['department']">
            Department
          </th>
          <th class="px-4 py-3" *ngIf="visibleColumns['status']">Status</th>
          <th
            class="px-4 py-3 cursor-pointer"
            *ngIf="visibleColumns['createdAt']"
            (click)="onSort('createdAt')"
          >
            Created
          </th>
          <th
            class="px-4 py-3 actions-col w-64"
            *ngIf="visibleColumns['actions']"
          >
            Actions
          </th>
        </tr>
      </thead>
      <tbody>
        <tr *ngIf="loading">
          <td colspan="7" class="px-4 py-6 text-center text-text-muted">
            Loading...
          </td>
        </tr>
        <tr
          *ngFor="let u of users; trackBy: trackByUser"
          class="border-t border-neutral-200"
        >
          <td class="px-4 py-3">
            <div class="flex items-center gap-3">
              <img
                [src]="getAvatarUrl(u.username || u.email)"
                [alt]="u.username || u.email"
                class="w-8 h-8 rounded-full border border-neutral-300"
              />
              <div>
                <div class="font-medium text-text" [title]="u.username">
                  {{ getDisplayName(u.username) }}
                </div>
                <div class="text-xs text-text-muted">
                  #{{ u._id | slice: -6 }}
                </div>
              </div>
            </div>
          </td>
          <td class="px-4 py-3" *ngIf="visibleColumns['email']">
            {{ u['email'] }}
          </td>
          <td class="px-4 py-3" *ngIf="visibleColumns['role']">
            {{ u.role ? u.role.name : '-' }}
          </td>
          <td class="px-4 py-3" *ngIf="visibleColumns['department']">
            {{ u.department ? u.department.name : '-' }}
          </td>
          <td class="px-4 py-3" *ngIf="visibleColumns['status']">
            <span
              class="inline-flex items-center gap-2 px-2 py-1 rounded-full text-xs"
              [ngClass]="{
                'bg-success/10 text-success': statusSeverity(u) === 'success',
                'bg-warning/10 text-warning': statusSeverity(u) === 'warning',
              }"
            >
              <i
                class="pi"
                [ngClass]="{
                  'pi-check-circle': u.isApproved,
                  'pi-clock': !u.isApproved,
                }"
              ></i>
              {{ statusLabel(u) }}
            </span>
          </td>
          <td class="px-4 py-3 w-56" *ngIf="visibleColumns['createdAt']">
            {{ u.createdAt | date: 'mediumDate' }}
          </td>
          <td class="px-4 py-3 w-64" *ngIf="visibleColumns['actions']">
            <div class="flex gap-2 flex-col sm:flex-row sm:flex-wrap">
              <!-- View -->
              <button
                pButton
                type="button"
                class="cursor-pointer"
                icon="pi pi-eye"
                label="View"
                [outlined]="true"
                severity="secondary"
                class="p-button-sm"
                [loading]="
                  processing.userId === u._id && processing.action === 'view'
                "
                (click)="onViewClick(u)"
              ></button>

              <!-- Edit -->
              <button
                pButton
                type="button"
                class="cursor-pointer"
                icon="pi pi-pencil"
                label="Edit"
                [outlined]="true"
                severity="info"
                class="p-button-sm"
                [loading]="
                  processing.userId === u._id && processing.action === 'edit'
                "
                (click)="onEditClick(u)"
              ></button>

              <!-- Approve (only when not approved) -->
              <button
                *ngIf="!u.isApproved"
                pButton
                type="button"
                class="cursor-pointer"
                icon="pi pi-check"
                label="Approve"
                severity="success"
                class="p-button-sm"
                [loading]="
                  processing.userId === u._id && processing.action === 'approve'
                "
                (click)="onApproveClick(u)"
              ></button>

              <!-- Reject (only when not approved) -->
              <button
                *ngIf="!u.isApproved"
                pButton
                type="button"
                class="cursor-pointer"
                icon="pi pi-times"
                label="Reject"
                severity="danger"
                class="p-button-sm"
                [loading]="
                  processing.userId === u._id && processing.action === 'reject'
                "
                (click)="onRejectClick(u)"
              ></button>
            </div>
          </td>
        </tr>
        <tr *ngIf="!loading && users.length === 0">
          <td colspan="7" class="px-4 py-8 text-center text-text-muted">
            No users found.
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <app-table-pagination
    [page]="page"
    [pages]="pages"
    [total]="total"
    [limit]="limit"
    (pageChange)="goToPage($event)"
    (limitChange)="onLimitChange($event)"
  ></app-table-pagination>
</div>
